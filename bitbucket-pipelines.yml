#  ==============  ë ˆí¬ì§€í† ë¦¬ í™˜ê²½ ë³€ìˆ˜  ==============
#   AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY,  AWS_DEFAULT_REGION       # CLI
#   AWS_ECR_REPO, AWS_ECR_NAME                                          # ECR
#   AWS_TASK_DEFINITION, AWS_ECS_CLUSTER, AWS_ECS_SERVICE               # ECS ë¼ì´ë¸Œ
#   AWS_TASK_DEFINITION_DEV, AWS_ECS_CLUSTER_DEV, AWS_ECS_SERVICE_DEV   # ECS ë°ë¸Œ
# =================================================
#  ë‚´ìš©
# =================================================
image: atlassian/default-image:2

pipelines:
  tags:
    '*.*.*-dev-*':
      - step:
          name: ğŸ—ï¸ Build & Push Image to ECR
          services:
            - docker
          script:
            # Docker ì´ë¯¸ì§€ ë¹Œë“œ
            - TARGET_VERSION=$BITBUCKET_TAG
            - docker build -t $AWS_ECR_NAME:$TARGET_VERSION -t $AWS_ECR_NAME .
            # ECRì— REPO íƒœê·¸ ì§€ì •
            - docker tag $AWS_ECR_NAME:$TARGET_VERSION $AWS_ECR_REPO/$AWS_ECR_NAME:$TARGET_VERSION
            - docker tag $AWS_ECR_NAME:$TARGET_VERSION $AWS_ECR_REPO/$AWS_ECR_NAME:latest
            # ECRì— í‘¸ì‹œ
            - pipe: atlassian/aws-ecr-push-image:2.6.0
              variables:
                AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID 
                AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
                AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION 
                IMAGE_NAME: $AWS_ECR_NAME
                TAGS: "$TARGET_VERSION latest"

      - step:
          name: ğŸš€ Deploy to ECS (DEV)
          image: amazon/aws-cli:2.30.3
          script:
            # ë ˆí¬í™˜ê²½ë³€ìˆ˜ export ë° dev ì¬í• ë‹¹ _ ìŠ¤í¬ë¦½íŠ¸ ì¬ì‚¬ìš© ìœ„í•´
            - export TARGET_VERSION=$BITBUCKET_TAG
            - export AWS_TASK_DEFINITION=$AWS_TASK_DEFINITION_DEV
            - export AWS_ECS_CLUSTER=$AWS_ECS_CLUSTER_DEV
            - export AWS_ECS_SERVICE=$AWS_ECS_SERVICE_DEV

            - chmod +x ./infra/convert-env-to-awsjson.sh ./infra/pipe-task-reversion.sh

            # Reversion & deploy
            - source ./infra/pipe-task-reversion.sh ./infra/convert-env-to-awsjson.sh .env.dev

            - aws ecs update-service --cluster $AWS_ECS_CLUSTER --service $AWS_ECS_SERVICE --task-definition $AWS_TASK_DEFINITION:$NEW_REVISION --force-new-deployment
            - echo "ECS await provisioning..."
            
            - aws ecs wait services-stable --cluster $AWS_ECS_CLUSTER --services $AWS_ECS_SERVICE
            - echo "âœ… ECS deployment completed successfully!"
    '*.*.*':
        - step:
            name: Image Build and Push to ECR
            services:
              - docker
            script:
              # Docker ì´ë¯¸ì§€ ë¹Œë“œ
              - TARGET_VERSION=$BITBUCKET_TAG
              - docker build -t $AWS_ECR_NAME:$TARGET_VERSION -t $AWS_ECR_NAME .
              # ECRì— REPO íƒœê·¸ ì§€ì •
              - docker tag $AWS_ECR_NAME:$TARGET_VERSION $AWS_ECR_REPO/$AWS_ECR_NAME:$TARGET_VERSION
              - docker tag $AWS_ECR_NAME:$TARGET_VERSION $AWS_ECR_REPO/$AWS_ECR_NAME:latest
              # ECRì— í‘¸ì‹œ
              - pipe: atlassian/aws-ecr-push-image:2.6.0
                variables:
                  AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID 
                  AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
                  AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION 
                  IMAGE_NAME: $AWS_ECR_NAME # ì‹¤ì œ ECR ë ˆí¬ë„¤ì„ ì‚¬ìš©.
                  TAGS: "$TARGET_VERSION latest" # ì´ë¯¸ì§€ íƒœê·¸_ ë²„ì „ê³¼ latest
        - step:
            name: PROD build task-definition END Deploy Ecs
            image: amazon/aws-cli:2.30.3 
            script:
              - echo "TODO ì»¤ìŠ¤í…€ íŒŒì´í”„ í•˜ë‚˜ë‘¬ì„œ. ë¹„íŠ¸ë²„í‚·ui ì—ì„œ ë²„ì „ ì…ë ¥í•´ì„œ ë°›ì•„ì™€ì„œ ì§„í–‰í•˜ê¸°"
              - echo "OR"
              - echo "TODO í”„ë¦¬ì¦ˆë§ˆ í’€ë•Œë¬¸ì— ë””ë¹„ì»¤ë„¥ì…˜ì´ë¤„ì ¸ì„œ ë² ìŠ¤ì²œ ì„œë²„ì—ì„œ env, sh ë“± ê°–ê³ ìˆë‹¤ê°€ ì§„í–‰í•˜ê¸°"